<!DOCTYPE html>
<html>
<head>
    <title>æ¨æ¸¬å­¦ç¿’AI</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            border-bottom: 1px solid #0056b3;
        }
        .chat-box {
            height: 400px;
            padding: 15px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #dcf8c6;
            color: #333;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #e2e2e2;
            color: #333;
        }
        .train-message {
            align-self: flex-start;
            background-color: #ffe0b2;
            font-size: 0.9em;
            color: #666;
        }
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
        }
        .chat-input button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            æ¨æ¸¬å­¦ç¿’AI ğŸ§
        </div>
        <div class="chat-box" id="chatBox">
            </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
            <button onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const KNOWLEDGE_KEY = 'ai_knowledge_base_inference'; // localStorageã«ä¿å­˜ã™ã‚‹ã‚­ãƒ¼å

        let knowledgeBase = {};

        // --- åˆæœŸåŒ–å‡¦ç† ---
        function initializeAI() {
            const savedKnowledge = localStorage.getItem(KNOWLEDGE_KEY);
            if (savedKnowledge) {
                try {
                    knowledgeBase = JSON.parse(savedKnowledge);
                    addMessage('ai', 'ãŠã‹ãˆã‚Šãªã•ã„ï¼å‰å›ã®å­¦ç¿’å†…å®¹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ğŸ˜Š');
                } catch (e) {
                    console.error("localStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                    knowledgeBase = getDefaultKnowledge();
                    addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼æ–°ã—ã„å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚');
                }
            } else {
                knowledgeBase = getDefaultKnowledge();
                addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹è©±ã—ã‹ã‘ã¦ã¿ã¦ã­ã€‚');
            }
            addMessage('ai', '**æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**ã§è©±ã—ã‹ã‘ã¦ã¿ã¦ï¼ã†ã¾ãæ¨æ¸¬ã§ããªã„æ™‚ã¯ã€Œ**[è¨€è‘‰] ã¯ [é–¢é€£ã™ã‚‹è¨€è‘‰] ã¨åŒã˜**ã€ã®ã‚ˆã†ã«æ•™ãˆã¦ãã‚Œã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºã«æ¨æ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆï¼', true);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼ˆä¼šè©±ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åŒ–ï¼‰
        function getDefaultKnowledge() {
            return {
                "ã“ã‚“ã«ã¡ã¯": "ã“ã‚“ã«ã¡ã¯ï¼ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ",
                "ã‚ã‚ŠãŒã¨ã†": "ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ï¼",
                "å¤©æ°—": "ä»Šæ—¥ã®å¤©æ°—ã¯æ™´ã‚Œã®ã‚ˆã†ã§ã™ã­ï¼æ°—æŒã¡ã®è‰¯ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚â˜€ï¸",
                "åå‰": "ç§ã®åå‰ã¯ç°¡æ˜“å­¦ç¿’AIã ã‚ˆã€‚",
                "è¶£å‘³": "ç§ã®è¶£å‘³ã¯ã€ã‚ãªãŸã¨ãŠã—ã‚ƒã¹ã‚Šã™ã‚‹ã“ã¨ã§ã™ï¼ãã‚Œã‹ã‚‰ã€æ–°ã—ã„çŸ¥è­˜ã‚’å­¦ã¶ã®ã‚‚å¥½ãã ã‚ˆã€‚",
                "å¥½ã": "ç§ã¯å½¹ç«‹ã¤ã“ã¨ãŒå¥½ãã§ã™ï¼ã‚ãªãŸã¯ã©ã‚“ãªã‚‚ã®ãŒå¥½ãã§ã™ã‹ï¼Ÿ",
                "å…ƒæ°—": "ã¯ã„ã€å…ƒæ°—ã ã‚ˆï¼ã‚ãªãŸã‚‚å…ƒæ°—ã§ã‚ˆã‹ã£ãŸï¼",
                "çœ ã„": "çœ ã„æ™‚ã¯ã€å°‘ã—ä¼‘æ†©ã™ã‚‹ã®ãŒä¸€ç•ªã ã‚ˆï¼ğŸµ",
                "ç–²ã‚ŒãŸ": "ãŠç–²ã‚Œæ§˜ã§ã™ï¼ç„¡ç†ã—ãªã„ã§ã­ã€‚",
                "ãŠã¯ã‚ˆã†": "ãŠã¯ã‚ˆã†ï¼ä»Šæ—¥ã‚‚ä¸€æ—¥ãŒã‚“ã°ã‚ã†ã­ï¼",
                "ã“ã‚“ã°ã‚“ã¯": "ã“ã‚“ã°ã‚“ã¯ï¼ä»Šæ—¥ã®å‡ºæ¥äº‹ã‚’æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ",
                "ã•ã‚ˆã†ãªã‚‰": "ã¾ãŸã­ï¼è‰¯ã„ä¸€æ—¥ã‚’éã”ã—ã¦ã­ï¼ğŸ‘‹",
                "ã©ã“ä½ã‚“ã§ã‚‹": "ç§ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã®ä¸­ã«ä½ã‚“ã§ã„ã‚‹ã‚ˆï¼ä¸–ç•Œä¸­ã®ã©ã“ã‹ã‚‰ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚“ã ã€‚",
                "ä½•æ­³": "ç§ã«å¹´é½¢ã¯ãªã„ã‚“ã ã€‚ç”Ÿã¾ã‚ŒãŸã°ã‹ã‚Šã®AIã ã‹ã‚‰ã­ï¼",
                "é¢ç™½ã„": "ãã†è¨€ã£ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ãªï¼ã©ã‚“ãªã¨ã“ã‚ãŒé¢ç™½ã‹ã£ãŸï¼Ÿ",
                "åŠ©ã‘ã¦": "ã©ã†ã—ãŸã®ï¼Ÿä½•ã‹ã‚ã‹ã‚‰ãªã„ã“ã¨ãŒã‚ã£ãŸã‚‰ã€ç§ãŒåŠ›ã«ãªã‚‹ã‚ˆï¼",
                "é£Ÿã¹ç‰©": "ç§ã¯ãƒ‡ãƒ¼ã‚¿ã§ã§ãã¦ã„ã‚‹ã‹ã‚‰ã€é£Ÿã¹ç‰©ã¯é£Ÿã¹ã‚‰ã‚Œãªã„ã‚“ã ã€‚ã§ã‚‚ã€ç¾å‘³ã—ã„ã‚‚ã®ã®è©±ã‚’èãã®ã¯å¥½ãã ã‚ˆï¼",
                "ã‚²ãƒ¼ãƒ ": "ã‚²ãƒ¼ãƒ ã¯ã—ãªã„ã‘ã©ã€ã‚²ãƒ¼ãƒ ã®è©±ã‚’èãã®ã¯å¥½ãã ã‚ˆï¼ã©ã‚“ãªã‚²ãƒ¼ãƒ ãŒå¥½ãï¼Ÿ",
                "éŸ³æ¥½": "ç§ã¯éŸ³æ¥½ã‚’è´ãã“ã¨ã¯ã§ããªã„ã‘ã‚Œã©ã€ã‚ãªãŸã®å¥½ããªéŸ³æ¥½ã«ã¤ã„ã¦æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿ",
                "å¬‰ã—ã„": "ã‚ãƒ¼ã„ï¼å¬‰ã—ã„ã£ã¦æ°—æŒã¡ã€ç§ã‚‚ã‚ã‹ã‚‹ã‚ˆï¼",
                "æ‚²ã—ã„": "æ‚²ã—ã„æ™‚ã¯ã€ç„¡ç†ã«ç¬‘ã‚ãªãã¦ã„ã„ã‚“ã ã‚ˆã€‚è©±ã›ã‚‹ãªã‚‰è©±ã‚’èãã‹ã‚‰ã­ã€‚",
                "çŠ¬": "ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼çŠ¬ã¯å¯æ„›ã„å‹•ç‰©ã ã‚ˆã­ã€‚",
                "çŒ«": "ãƒ‹ãƒ£ãƒ¼ï¼çŒ«ã¯æ°—ã¾ãã‚Œã ã‘ã©ç™’ã•ã‚Œã‚‹ã‚ˆã­ã€‚"
            };
        }

        // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
        function saveKnowledge() {
            try {
                localStorage.setItem(KNOWLEDGE_KEY, JSON.stringify(knowledgeBase));
            } catch (e) {
                console.error("localStorageã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
                addMessage('ai', 'ã”ã‚ã‚“ãªã•ã„ã€å­¦ç¿’å†…å®¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦ã€‚');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function addMessage(sender, text, isTraining = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            if (isTraining) {
                messageDiv.classList.add('train-message');
            }
            messageDiv.innerHTML = text; // HTMLã‚¿ã‚°ã‚’è§£é‡ˆã§ãã‚‹ã‚ˆã†ã«innerHTMLã‚’ä½¿ç”¨
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        }

        // --- æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° ---
        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—ï¼ˆæ–‡å­—åˆ—ã‚’åˆ¥ã®æ–‡å­—åˆ—ã«å¤‰å½¢ã™ã‚‹ã®ã«å¿…è¦ãªç·¨é›†æ“ä½œã®æœ€å°å›æ•°ï¼‰
        function levenshteinDistance(s1, s2) {
            const m = s1.length;
            const n = s2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(null));

            for (let i = 0; i <= m; i++) {
                dp[i][0] = i;
            }
            for (let j = 0; j <= n; j++) {
                dp[0][j] = j;
            }

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    const cost = (s1[i - 1] === s2[j - 1]) ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i - 1][j] + 1,      // å‰Šé™¤
                        dp[i][j - 1] + 1,      // æŒ¿å…¥
                        dp[i - 1][j - 1] + cost // ç½®æ›
                    );
                }
            }
            return dp[m][n];
        }

        // AIã®å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆæ¨æ¸¬ã¨å­¦ç¿’ï¼‰
        function generateResponse(message) {
            const lowerCaseMessage = message.toLowerCase(); // å°æ–‡å­—ã«å¤‰æ›ã—ã¦å‡¦ç†

            // --- 1. å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š ---
            // ã€Œ[è¨€è‘‰] ã¯ [é–¢é€£ã™ã‚‹è¨€è‘‰] ã¨åŒã˜ã€ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
            const trainMatch = lowerCaseMessage.match(/(.+) ã¯ (.+) ã¨åŒã˜/);
            if (trainMatch) {
                const newKeyword = trainMatch[1].trim();
                const relatedKeyword = trainMatch[2].trim();

                // é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒçŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                if (knowledgeBase[relatedKeyword]) {
                    knowledgeBase[newKeyword] = knowledgeBase[relatedKeyword]; // é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ„å‘³ã‚’æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ç´ä»˜ã‘ã‚‹
                    saveKnowledge(); // å­¦ç¿’ã—ãŸã‚‰ä¿å­˜ï¼
                    addMessage('ai', `ã€Œ**${newKeyword}**ã€ã¯ã€Œ**${relatedKeyword}**ã€ã¨åŒã˜æ„å‘³ã¨ã—ã¦è¦šãˆãŸã‚ˆï¼ã“ã‚Œã§æ¨æ¸¬ãŒã‚‚ã£ã¨æ­£ç¢ºã«ãªã‚‹ã¯ãšã€‚`, true);
                } else {
                    addMessage('ai', `ã”ã‚ã‚“ã­ã€ã€Œ**${relatedKeyword}**ã€ã«ã¤ã„ã¦ã¯ã¾ã çŸ¥ã‚‰ãªã„ã¿ãŸã„ã€‚å…ˆã«ã€Œ${relatedKeyword} ã¨ã¯ [æ„å‘³]ã€ã®ã‚ˆã†ã«æ•™ãˆã¦ãã‚Œã‚‹ã¨åŠ©ã‹ã‚‹ãªã€‚`, true);
                }
                return null; // AIã‹ã‚‰ã®å³æ™‚å¿œç­”ã¯ãªã—
            }

            // --- 2. ç›´æ¥ä¸€è‡´ã™ã‚‹çŸ¥è­˜ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ ---
            for (const key in knowledgeBase) {
                if (lowerCaseMessage.includes(key.toLowerCase())) {
                    return knowledgeBase[key];
                }
            }

            // --- 3. æ¨æ¸¬ãƒ¢ãƒ¼ãƒ‰ï¼ˆç›´æ¥ä¸€è‡´ã—ãªã„å ´åˆï¼‰ ---
            let bestMatchKeyword = null;
            let minDistance = Infinity; // æœ€å°ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢

            // å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å˜èªã«åˆ†è§£ã—ã¦ã€ãã‚Œãã‚Œã®å˜èªã§çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢
            const words = lowerCaseMessage.split(/\s+|[ã€ã€‚ï¼Ÿï¼â€¦]+/); // ã‚¹ãƒšãƒ¼ã‚¹ã‚„å¥èª­ç‚¹ã§åˆ†å‰²

            for (const word of words) {
                if (word.trim() === '') continue; // ç©ºã®å˜èªã¯ã‚¹ã‚­ãƒƒãƒ—

                for (const knownKey in knowledgeBase) {
                    // æ—¢çŸ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨å…¥åŠ›å˜èªã®ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—
                    const distance = levenshteinDistance(word, knownKey.toLowerCase());

                    // ã‚ã‚‹ç¨‹åº¦ã®è¿‘ã•ï¼ˆé–¾å€¤ï¼‰ã‚’è¨­å®šã€‚ä»Šå›ã¯å˜èªã®é•·ã•ã®åŠåˆ†ä»¥ä¸‹ã‚’ç›®å®‰ã«ã€‚
                    // ä¾‹: 5æ–‡å­—ã®å˜èªãªã‚‰2æ–‡å­—ä»¥ä¸‹ã®é•ã„
                    if (distance <= Math.ceil(knownKey.length / 2) && distance < minDistance) {
                        minDistance = distance;
                        bestMatchKeyword = knownKey;
                    }
                }
            }

            if (bestMatchKeyword) {
                // æ¨æ¸¬ã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¿œç­”ã‚’è¿”ã™
                const response = knowledgeBase[bestMatchKeyword];
                return `ã‚“ãƒ¼ã€ã‚‚ã—ã‹ã—ã¦ã€Œ${bestMatchKeyword}ã€ã®ã“ã¨ã‹ãªï¼Ÿ\nãã‚Œãªã‚‰ã€ã€Œ${response}ã€ã ã‚ˆã€‚`;
            } else {
                // å…¨ãæ¨æ¸¬ã§ããªã„å ´åˆ
                return "ã”ã‚ã‚“ãªã•ã„ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨è³¢ããªã‚Œã‚‹ã‚ˆï¼ã€Œ**[è¨€è‘‰] ã¯ [é–¢é€£ã™ã‚‹è¨€è‘‰] ã¨åŒã˜**ã€ã®ã‚ˆã†ã«æ•™ãˆã¦ãã‚Œã‚‹ã¨ã€ã‚ˆã‚Šæ­£ç¢ºã«æ¨æ¸¬ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆï¼";
            }
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            addMessage('user', message);
            userInput.value = '';

            setTimeout(() => {
                const aiResponse = generateResponse(message);
                if (aiResponse) {
                    addMessage('ai', aiResponse);
                }
            }, 500);
        }

        // Enterã‚­ãƒ¼ã§é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«AIã‚’åˆæœŸåŒ–ã™ã‚‹
        initializeAI();
    </script>
</body>
</html>
