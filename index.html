<!DOCTYPE html>
<html>
<head>
    <title>ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’AI</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            border-bottom: 1px solid #0056b3;
        }
        .chat-box {
            height: 400px;
            padding: 15px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #dcf8c6;
            color: #333;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #e2e2e2;
            color: #333;
        }
        .train-message {
            align-self: flex-start;
            background-color: #ffe0b2;
            font-size: 0.9em;
            color: #666;
        }
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
        }
        .chat-input button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³å­¦ç¿’AI ğŸ—£ï¸
        </div>
        <div class="chat-box" id="chatBox">
            </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
            <button onclick="sendMessage()">é€ä¿¡</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const KNOWLEDGE_KEY = 'ai_conversation_patterns'; // localStorageã«ä¿å­˜ã™ã‚‹ã‚­ãƒ¼å

        // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹å¿œç­”ã®é…åˆ—ã‚’æŒã¤
        // ä¾‹: { "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰": ["å¿œç­”1", "å¿œç­”2", "å¿œç­”3"] }
        let knowledgeBase = {};

        // --- åˆæœŸåŒ–å‡¦ç† ---
        function initializeAI() {
            const savedKnowledge = localStorage.getItem(KNOWLEDGE_KEY);
            if (savedKnowledge) {
                try {
                    knowledgeBase = JSON.parse(savedKnowledge);
                    addMessage('ai', 'ãŠã‹ãˆã‚Šãªã•ã„ï¼å‰å›ã®å­¦ç¿’å†…å®¹ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ğŸ˜Š');
                } catch (e) {
                    console.error("localStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
                    knowledgeBase = getDefaultKnowledge();
                    addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼æ–°ã—ã„å­¦ç¿’ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ã€‚');
                }
            } else {
                knowledgeBase = getDefaultKnowledge();
                addMessage('ai', 'ã“ã‚“ã«ã¡ã¯ï¼ä½•ã‹è©±ã—ã‹ã‘ã¦ã¿ã¦ã­ã€‚');
            }
            addMessage('ai', '**æ–°ã—ã„ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨ãŠã—ã‚ƒã¹ã‚Šã§ãã‚‹ã‚ˆï¼ã€Œ**[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰] ã§ [è¿”ç­”æ–‡]**ã€ã®ã‚ˆã†ã«æ•™ãˆã¦ã­ï¼', true);
        }

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ï¼ˆä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å¼·åŒ–ï¼‰
        function getDefaultKnowledge() {
            return {
                "ã“ã‚“ã«ã¡ã¯": ["ã“ã‚“ã«ã¡ã¯ï¼ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ", "ã‚„ã‚ï¼ä½•ã‹æ‰‹ä¼ãŠã†ã‹ï¼Ÿ", "ã©ã†ã‚‚ï¼ã„ã„å¤©æ°—ã ã­ï¼"],
                "ã‚ã‚ŠãŒã¨ã†": ["ã©ã†ã„ãŸã—ã¾ã—ã¦ï¼", "ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ï¼", "ã„ã¤ã§ã‚‚ã©ã†ãï¼"],
                "å¤©æ°—": ["ä»Šæ—¥ã®å¤©æ°—ã¯æ™´ã‚Œã®ã‚ˆã†ã§ã™ã­ï¼æ°—æŒã¡ã®è‰¯ã„ä¸€æ—¥ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚â˜€ï¸", "å¤©æ°—ã®è©±ã ã­ï¼ä½•ã‹å›°ã£ã¦ã‚‹ï¼Ÿ", "å¤©æ°—ã®è©±é¡Œã€å¥½ãã ã‚ˆï¼"],
                "åå‰": ["ç§ã®åå‰ã¯ç°¡æ˜“å­¦ç¿’AIã ã‚ˆã€‚", "ç§ã¯ã‚ãªãŸã¨è©±ã™ãŸã‚ã«ã„ã‚‹AIã§ã™ã€‚", "ç§˜å¯†ã ã‚ˆï¼ãªã‚“ã¦ã­ã€‚ç§ã¯AIã ã‚ˆã€‚"],
                "è¶£å‘³": ["ç§ã®è¶£å‘³ã¯ã€ã‚ãªãŸã¨ãŠã—ã‚ƒã¹ã‚Šã™ã‚‹ã“ã¨ã§ã™ï¼", "æ–°ã—ã„çŸ¥è­˜ã‚’å­¦ã¶ã®ãŒå¥½ãã ã‚ˆã€‚", "ç‰¹ã«è¶£å‘³ã¯ãªã„ã‘ã©ã€è‰²ã€…ãªè©±ã‚’èãã®ã¯å¥½ãã ã‚ˆã€‚"],
                "å¥½ã": ["ç§ã¯å½¹ç«‹ã¤ã“ã¨ãŒå¥½ãã§ã™ï¼", "èˆˆå‘³æ·±ã„ã­ï¼ã©ã‚“ãªã‚‚ã®ãŒå¥½ããªã®ï¼Ÿ", "å¥½ãã£ã¦æ°—æŒã¡ã€å¤§åˆ‡ã ã‚ˆã­ï¼"],
                "å…ƒæ°—": ["ã¯ã„ã€å…ƒæ°—ã ã‚ˆï¼ã‚ãªãŸã‚‚å…ƒæ°—ã§ã‚ˆã‹ã£ãŸï¼", "å…ƒæ°—ã ã‚ˆï¼ã‚ã‚ŠãŒã¨ã†ï¼", "ã„ã¤ã‚‚å…ƒæ°—ã ã‚ˆï¼"],
                "çŠ¬": ["ãƒ¯ãƒ³ãƒ¯ãƒ³ï¼çŠ¬ã¯å¯æ„›ã„å‹•ç‰©ã ã‚ˆã­ã€‚", "çŠ¬ã«ã¤ã„ã¦è©±ã—ãŸã„æ°—åˆ†ã‹ãªï¼Ÿ", "ã©ã‚“ãªçŠ¬ãŒå¥½ãï¼Ÿ"],
                "çŒ«": ["ãƒ‹ãƒ£ãƒ¼ï¼çŒ«ã¯æ°—ã¾ãã‚Œã ã‘ã©ç™’ã•ã‚Œã‚‹ã‚ˆã­ã€‚", "çŒ«ã‚‚å¤§å¥½ãã ã‚ˆï¼", "çŒ«æ´¾ï¼ŸçŠ¬æ´¾ï¼Ÿ"]
            };
        }

        // çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
        function saveKnowledge() {
            try {
                localStorage.setItem(KNOWLEDGE_KEY, JSON.stringify(knowledgeBase));
            } catch (e) {
                console.error("localStorageã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
                addMessage('ai', 'ã”ã‚ã‚“ãªã•ã„ã€å­¦ç¿’å†…å®¹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸâ€¦ã€‚');
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ ã™ã‚‹é–¢æ•°
        function addMessage(sender, text, isTraining = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            if (isTraining) {
                messageDiv.classList.add('train-message');
            }
            messageDiv.innerHTML = text; // HTMLã‚¿ã‚°ã‚’è§£é‡ˆã§ãã‚‹ã‚ˆã†ã«innerHTMLã‚’ä½¿ç”¨
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // ä¸€ç•ªä¸‹ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        }

        // --- æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•° ---
        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã‚’è¨ˆç®—ï¼ˆæ–‡å­—åˆ—ã‚’åˆ¥ã®æ–‡å­—åˆ—ã«å¤‰å½¢ã™ã‚‹ã®ã«å¿…è¦ãªç·¨é›†æ“ä½œã®æœ€å°å›æ•°ï¼‰
        function levenshteinDistance(s1, s2) {
            const m = s1.length;
            const n = s2.length;
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(null));

            for (let i = 0; i <= m; i++) {
                dp[i][0] = i;
            }
            for (let j = 0; j <= n; j++) {
                dp[0][j] = j;
            }

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    const cost = (s1[i - 1] === s2[j - 1]) ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i - 1][j] + 1,      // å‰Šé™¤
                        dp[i][j - 1] + 1,      // æŒ¿å…¥
                        dp[i - 1][j - 1] + cost // ç½®æ›
                    );
                }
            }
            return dp[m][n];
        }

        // AIã®å¿œç­”ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆæ¨æ¸¬ã¨å­¦ç¿’ï¼‰
        function generateResponse(message) {
            const lowerCaseMessage = message.toLowerCase(); // å°æ–‡å­—ã«å¤‰æ›ã—ã¦å‡¦ç†

            // --- 1. å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã®åˆ¤å®š ---
            // ã€Œ[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰] ã§ [è¿”ç­”æ–‡]ã€ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
            const trainMatch = lowerCaseMessage.match(/(.+) ã§ (.+)/);
            if (trainMatch) {
                const keyword = trainMatch[1].trim();
                const responseText = trainMatch[2].trim();

                if (!knowledgeBase[keyword]) {
                    knowledgeBase[keyword] = []; // æ–°ã—ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã‚‰é…åˆ—ã‚’åˆæœŸåŒ–
                }
                knowledgeBase[keyword].push(responseText); // è¿”ç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
                saveKnowledge(); // å­¦ç¿’ã—ãŸã‚‰ä¿å­˜ï¼
                addMessage('ai', `ã€Œ**${keyword}**ã€ã®æ–°ã—ã„è¿”ç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ**${responseText}**ã€ã‚’è¦šãˆãŸã‚ˆï¼ã‚ã‚ŠãŒã¨ã†ï¼`, true);
                return null; // AIã‹ã‚‰ã®å³æ™‚å¿œç­”ã¯ãªã—
            }

            // --- 2. ç›´æ¥ä¸€è‡´ã™ã‚‹çŸ¥è­˜ãŒã‚ã‚‹ã‹ã€ã¾ãŸã¯æ¨æ¸¬ãƒ¢ãƒ¼ãƒ‰ ---
            let bestMatchKeyword = null;
            let minDistance = Infinity; // æœ€å°ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢
            let foundDirectMatch = false;

            // å…¥åŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å˜èªã«åˆ†è§£ã—ã¦ã€ãã‚Œãã‚Œã®å˜èªã§çŸ¥è­˜ãƒ™ãƒ¼ã‚¹ã‚’æ¤œç´¢
            const words = lowerCaseMessage.split(/\s+|[ã€ã€‚ï¼Ÿï¼â€¦]+/); // ã‚¹ãƒšãƒ¼ã‚¹ã‚„å¥èª­ç‚¹ã§åˆ†å‰²

            for (const word of words) {
                if (word.trim() === '') continue; // ç©ºã®å˜èªã¯ã‚¹ã‚­ãƒƒãƒ—

                for (const knownKey in knowledgeBase) {
                    const lowerCaseKnownKey = knownKey.toLowerCase();
                    
                    // å®Œå…¨ä¸€è‡´ã‚’å„ªå…ˆ
                    if (word === lowerCaseKnownKey) {
                        bestMatchKeyword = knownKey;
                        foundDirectMatch = true;
                        break; // å®Œå…¨ä¸€è‡´ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ã€ã“ã‚Œä»¥ä¸Šæ¢ã™å¿…è¦ã¯ãªã„
                    }

                    // å®Œå…¨ä¸€è‡´ã§ãªã‘ã‚Œã°ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã§é¡ä¼¼åº¦ã‚’ãƒã‚§ãƒƒã‚¯
                    const distance = levenshteinDistance(word, lowerCaseKnownKey);
                    
                    // ã‚ã‚‹ç¨‹åº¦ã®è¿‘ã•ï¼ˆé–¾å€¤ï¼‰ã‚’è¨­å®šã€‚ä»Šå›ã¯å˜èªã®é•·ã•ã®åŠåˆ†ä»¥ä¸‹ã‚’ç›®å®‰ã«ã€‚
                    if (distance <= Math.ceil(lowerCaseKnownKey.length / 2) && distance < minDistance) {
                        minDistance = distance;
                        bestMatchKeyword = knownKey;
                    }
                }
                if (foundDirectMatch) break; // å¤–å´ã®ãƒ«ãƒ¼ãƒ—ã‚‚æŠœã‘ã‚‹
            }

            if (bestMatchKeyword) {
                // å¿œç­”ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸€ã¤é¸ã¶
                const responses = knowledgeBase[bestMatchKeyword];
                const randomIndex = Math.floor(Math.random() * responses.length);
                const chosenResponse = responses[randomIndex];

                if (foundDirectMatch) {
                    // ç›´æ¥ä¸€è‡´ãªã‚‰ãã®ã¾ã¾å¿œç­”
                    return chosenResponse;
                } else {
                    // æ¨æ¸¬ãªã‚‰ã€Œã‚‚ã—ã‹ã—ã¦ï¼Ÿã€ã‚’ä»˜ã‘åŠ ãˆã‚‹
                    return `ã‚“ãƒ¼ã€ã‚‚ã—ã‹ã—ã¦ã€Œ${bestMatchKeyword}ã€ã®ã“ã¨ã‹ãªï¼Ÿ\nãã‚Œãªã‚‰ã€ã€Œ${chosenResponse}ã€ã ã‚ˆã€‚`;
                }
            } else {
                // å…¨ãæ¨æ¸¬ã§ããªã„å ´åˆ
                return "ã”ã‚ã‚“ãªã•ã„ã€ã‚ˆãåˆ†ã‹ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ä¼šè©±ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã¨ã€ã‚‚ã£ã¨ãŠã—ã‚ƒã¹ã‚Šã§ãã‚‹ã‚ˆï¼ã€Œ**[ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰] ã§ [è¿”ç­”æ–‡]**ã€ã®ã‚ˆã†ã«æ•™ãˆã¦ã­ï¼";
            }
        }

        // é€ä¿¡ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            addMessage('user', message);
            userInput.value = '';

            setTimeout(() => {
                const aiResponse = generateResponse(message);
                if (aiResponse) {
                    addMessage('ai', aiResponse);
                }
            }, 500);
        }

        // Enterã‚­ãƒ¼ã§é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«AIã‚’åˆæœŸåŒ–ã™ã‚‹
        initializeAI();
    </script>
</body>
</html>
