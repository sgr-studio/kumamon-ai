<!DOCTYPE html>
<html>
<head>
    <title>学習する簡易AI (保存機能付き)</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            font-size: 1.2em;
            text-align: center;
            border-bottom: 1px solid #0056b3;
        }
        .chat-box {
            height: 400px;
            padding: 15px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #dcf8c6;
            color: #333;
        }
        .ai-message {
            align-self: flex-start;
            background-color: #e2e2e2;
            color: #333;
        }
        .train-message {
            align-self: flex-start;
            background-color: #ffe0b2;
            font-size: 0.9em;
            color: #666;
        }
        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }
        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
        }
        .chat-input button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 18px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            学習するおしゃべりAI 📚💾
        </div>
        <div class="chat-box" id="chatBox">
            </div>
        <div class="chat-input">
            <input type="text" id="userInput" placeholder="メッセージを入力...">
            <button onclick="sendMessage()">送信</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const KNOWLEDGE_KEY = 'ai_knowledge_base'; // localStorageに保存するキー名

        // AIが学習した知識を保存するオブジェクト
        // まずはlocalStorageから読み込み、なければ初期値を設定
        let knowledgeBase = {};

        // --- 初期化処理 ---
        function initializeAI() {
            // localStorageから知識ベースを読み込む
            const savedKnowledge = localStorage.getItem(KNOWLEDGE_KEY);
            if (savedKnowledge) {
                try {
                    knowledgeBase = JSON.parse(savedKnowledge);
                    addMessage('ai', 'おかえりなさい！前回の学習内容をロードしました。😊');
                } catch (e) {
                    console.error("localStorageからの読み込みエラー:", e);
                    knowledgeBase = getDefaultKnowledge();
                    addMessage('ai', 'こんにちは！新しい学習を始めましょう。');
                }
            } else {
                knowledgeBase = getDefaultKnowledge();
                addMessage('ai', 'こんにちは！何か話しかけてみてね。');
            }
            addMessage('ai', '知らない言葉があったら「**[その言葉] とは [意味]**」と教えてくれると覚えるよ！', true); // isTrainingをtrueにして強調
        }

        // デフォルトの知識ベース
        function getDefaultKnowledge() {
            return {
                "こんにちは": "こんにちは！お元気ですか？",
                "ありがとう": "どういたしまして！お役に立てて嬉しいです！",
                "天気": "今日の天気は晴れのようですね！気持ちの良い一日になりますように。☀️",
                "名前": "私の名前は簡易学習AIだよ。"
            };
        }

        // 知識ベースをlocalStorageに保存する関数
        function saveKnowledge() {
            try {
                localStorage.setItem(KNOWLEDGE_KEY, JSON.stringify(knowledgeBase));
            } catch (e) {
                console.error("localStorageへの保存エラー:", e);
                addMessage('ai', 'ごめんなさい、学習内容の保存に失敗しました…。');
            }
        }

        // メッセージをチャットボックスに追加する関数
        function addMessage(sender, text, isTraining = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
            if (isTraining) {
                messageDiv.classList.add('train-message');
            }
            messageDiv.innerHTML = text; // HTMLタグを解釈できるようにinnerHTMLを使用
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // 一番下までスクロール
        }

        // AIの応答を生成する関数（学習と応答）
        function generateResponse(message) {
            const lowerCaseMessage = message.toLowerCase(); // 小文字に変換して処理

            // 学習モードの判定：「[言葉] とは [意味]」の形式をチェック
            const trainMatch = lowerCaseMessage.match(/(.+) とは (.+)/);
            if (trainMatch) {
                const keyword = trainMatch[1].trim();
                const meaning = trainMatch[2].trim();
                knowledgeBase[keyword] = meaning; // 知識ベースに追加
                saveKnowledge(); // 学習したら保存！
                addMessage('ai', `「**${keyword}**」は「**${meaning}**」として覚えたよ！ありがとう！`, true);
                return null; // AIからの即時応答はなし
            }

            // 知識ベースから応答を探す
            for (const key in knowledgeBase) {
                if (lowerCaseMessage.includes(key)) {
                    return knowledgeBase[key];
                }
            }

            // 知らない場合
            return "ごめんなさい、よく分かりません。もしよければ「**[その言葉] とは [意味]**」と教えてくれると覚えるよ！";
        }

        // 送信ボタンが押されたときの処理
        function sendMessage() {
            const message = userInput.value.trim(); // 前後の空白を削除
            if (message === '') return; // メッセージが空の場合は何もしない

            addMessage('user', message); // ユーザーメッセージをチャットボックスに追加
            userInput.value = ''; // 入力欄をクリア

            // AIの応答を少し遅らせて自然に見せる
            setTimeout(() => {
                const aiResponse = generateResponse(message);
                if (aiResponse) { // 学習モードでなければ応答
                    addMessage('ai', aiResponse); // AIのメッセージをチャットボックスに追加
                }
            }, 500); // 0.5秒後に応答
        }

        // Enterキーで送信できるようにする
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ページ読み込み時にAIを初期化する
        initializeAI();
    </script>
</body>
</html>
